<!DOCTYPE html>
<html>
<head>
    <title>Lead-Steer-Execute-By-Release</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",onScopeChange:function(scope){this._summarizeMetrics()},_addLine:function(container,value){container.add({xtype:"component",html:value})},_summarizeMetrics:function(){var PROJECT_RADIAN="37192747640",PROJECT_BUSINESS="37637012809",PROJECT_SPRINT_TEAMS="37213611687",PROJECT_SUPPORTING_TEAMS="37192947515",PROJECT_EXECUTION="37192748545",PROJECT_AWS_TEAMS="35625370074",PROJECT_ECMLDR_TEAMS="35625373948",PROJECT_PAS_TEAMS="34799452294",PROJECT_SFDC_TEAMS="35625125755",me=this,promises=[],resultArray=[];promises.push(me._getCount("PortfolioItem/Feature","Defined Business Features",me._filterByAttribute("State.Name","Defined"),PROJECT_BUSINESS,40)),me._count("TestCase","TestFolder.FormattedID","TF196",PROJECT_RADIAN).then({success:function(results){var deferred=Ext.create("Deft.Deferred");return Ext.Array.each(results,function(result){deferred.resolve(result.Count)}),deferred}}).then({success:function(testFolderCases){promises.push(me._getCount("TestCase","TF196 Failed Test Cases",me._filterVerdictByTestFolder("Fail","TF196"),PROJECT_RADIAN,testFolderCases)),promises.push(me._getCount("TestCase","TF196 Passing Test Cases",me._filterVerdictByTestFolder("Pass","TF196"),PROJECT_RADIAN,testFolderCases)),promises.push(me._getCount("TestCase","TF196 Other Test Cases",me._filterNoVerdictByTestFolder("TF196"),PROJECT_RADIAN,testFolderCases)),Deft.Promise.all(promises).then({success:function(results){Ext.Array.each(results,function(result){resultArray.push(result)}),me._makeGrid(resultArray)}})},failure:function(res){me._addLine(me,"died ")}})},_pullCount:function(results){Ext.Array.each(results,function(result){return this._addLine(this,"Resolved "+result.Caption+" "+result.Count),result.Count})},_count:function(modelType,attribute,attrValue){var deferred=Ext.create("Deft.Deferred"),artifactStore=Ext.create("Rally.data.wsapi.Store",{model:modelType,pagesize:1,autoLoad:!0,filters:[{property:attribute,operator:"=",value:attrValue}],sorters:[{property:"FormattedID",direction:"ASC"}],listeners:{load:function(store,records){var manualCount=store.getTotalCount();result={Caption:modelType,Count:manualCount},deferred.resolve(result)}}});return deferred},_getCount:function(modelType,caption,filter,project,baseline){var deferred=Ext.create("Deft.Deferred"),artifactStore=Ext.create("Rally.data.wsapi.Store",{model:modelType,pagesize:1,autoLoad:!0,filters:filter,context:{project:"/project/"+project},sorters:[{property:"FormattedID",direction:"ASC"}],listeners:{load:function(store,records){var manualCount=store.getTotalCount();result={Caption:caption,Count:manualCount,Metric:(100*(manualCount/baseline)).toFixed(1)+"%"},deferred.resolve(result)}}});return deferred},_filterByAttribute:function(attribute,attrValue){var filters=Ext.create("Rally.data.QueryFilter",{property:attribute,operator:"=",value:attrValue}),timeboxScope=this.getContext().getTimeboxScope();return timeboxScope&&(filters=filters.and(timeboxScope.getQueryFilter())),filters},_filterVerdictByTestFolder:function(attrValue,folder){var filters=Ext.create("Rally.data.QueryFilter",{property:"LastVerdict",operator:"=",value:attrValue});return filters=filters.and(Ext.create("Rally.data.QueryFilter",{property:"TestFolder.FormattedID",operator:"=",value:folder}))},_filterNoVerdictByTestFolder:function(folder){var filters=Ext.create("Rally.data.QueryFilter",{property:"LastVerdict",operator:"!=",value:"Pass"});return filters=filters.and(Ext.create("Rally.data.QueryFilter",{property:"LastVerdict",operator:"!=",value:"Fail"})),filters=filters.and(Ext.create("Rally.data.QueryFilter",{property:"TestFolder.FormattedID",operator:"=",value:folder}))},_filterEstimatedStoriesByRelease:function(value){var filters=Ext.create("Rally.data.QueryFilter",{property:"Release.Name",operator:"=",value:value});return filters=filters.and(Ext.create("Rally.data.QueryFilter",{property:"PlanEstimate",operator:">",value:"0"}))},_makeGrid:function(results){var me=this;me._summaryGrid&&me._summaryGrid.destroy();var gridStore=Ext.create("Rally.data.custom.Store",{data:results,pageSize:25,remoteSort:!1});me._summaryGrid=Ext.create("Rally.ui.grid.Grid",{itemId:"artifactGrid",store:gridStore,columnWidth:.3,columnCfgs:[{text:"Metric",dataIndex:"Metric"},{text:"Caption",dataIndex:"Caption"},{text:"Count",dataIndex:"Count"}]}),me.add(me._summaryGrid),me._summaryGrid.reconfigure(gridStore)}});

            Rally.launchApp('CustomApp', {
                name:"Lead-Steer-Execute-By-Release",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
